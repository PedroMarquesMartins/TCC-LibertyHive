<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Detalhes do Item</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="icon" type="image/png" href="favicon.png" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body { min-height: 100vh; display: flex; flex-direction: column; }
  main { flex: 1; }
  .detalhes-container { display: flex; gap: 20px; margin-top: 20px; align-items: flex-start; }

  .imagem-principal { flex: 2; display: flex; flex-direction: column; align-items: center; }
  .imagem-principal img { width: 400px; height: 400px; object-fit: cover; border:1px solid #ccc; border-radius: 8px; }
  .imagens-secundarias { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top:10px; }
  .imagens-secundarias img { width: 80px; height: 80px; object-fit: cover; border-radius:5px; border:1px solid #ccc; }

  .info-item { margin-top:15px; width:100%; text-align:left; padding-left:5px; }
  .info-item p { margin:3px 0; font-size:14px; }
  .info-item .descricao { margin-top:10px; font-size:14px; color:#555; }

  .lista-itens-usuario { flex: 1; max-height: 500px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; padding-right:5px; }

  .item-card {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-height: 180px;
    max-height: 250px;
    cursor: pointer;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }

  .item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }

  .item-card.selected {
    border: 2px solid #ff9800;
    background-color: #fff3e0;
  }

  .item-card img { width: 80px; height: 80px; object-fit: cover; border-radius:5px; margin-bottom:5px; }
  .item-card h6 { margin:0; font-size:14px; font-weight:bold; word-wrap: break-word; }
  .item-card p { margin:2px 0; font-size:12px; color:#555; word-wrap: break-word; }

  #btnPropor {
    margin-top: 15px;
    width: 100%;
  }
</style>
</head>
<body>

<header class="navbar navbar-expand-lg bg-warning shadow-sm px-3">
  <a class="navbar-brand fw-bold" href="#"><img src="imagens/logo.png" alt="LibertyHive" width="40"></a>
  <div class="d-flex ms-auto gap-2">
    <button class="btn btn-outline-dark btn-sm" onclick="window.location.href='inicio.html'">Início</button>
    <button class="btn btn-outline-dark btn-sm" onclick="logout()">Sair</button>
  </div>
</header>

<main class="container my-4">
  <h2 id="nomePostagem"></h2>
  <div class="detalhes-container">
    <div class="imagem-principal">
      <img id="imgPrincipal" src="./imagens/placeholder.png" alt="Imagem do item">
      <div class="imagens-secundarias" id="imagensSecundarias"></div>
      <div class="info-item">
        <p id="nomeUsuario"></p>
        <p id="tipoItem"></p>
        <p id="ufItem"></p>
        <p id="categoriaItem"></p>
        <p id="categoriasInteresse"></p>
        <p class="descricao" id="descricaoItem"></p>
      </div>
    </div>

    <div class="lista-itens-usuario" id="listaItensUsuario">
    </div>
  </div>
  <button id="btnPropor" class="btn btn-warning">Propor Troca</button>
</main>

<script>
const queryParams = new URLSearchParams(window.location.search);
const itemId = queryParams.get("id");
const token = localStorage.getItem("token");
if(!token) window.location.href = 'login.html';

let itemSelecionadoId = null;
let propostasExistentes = [];

async function carregarPropostas() {
    try {
        const resp = await fetch("http://localhost:8080/api/propostas/listarPropostas", {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if(!resp.ok) throw new Error("Erro ao buscar propostas");
        const data = await resp.json();
        propostasExistentes = data.map(p => ({
            itemDesejadoId: p.itemDesejado.id,
            itemOferecidoId: p.itemOferecido.id
        }));
    } catch(err) {
        console.error("Erro ao carregar propostas:", err);
    }
}

async function carregarDetalhes() {
    try {
        const resp = await fetch(`http://localhost:8080/api/postagens/${itemId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if(!resp.ok) throw new Error("Item não encontrado");
        const item = await resp.json();

        document.getElementById("nomePostagem").textContent = item.nomePostagem;
        document.getElementById("imgPrincipal").src = item.imagem ? `data:image/jpeg;base64,${item.imagem}` : './imagens/placeholder.png';
        document.getElementById("categoriaItem").textContent = "Categoria: " + item.categoria;
        document.getElementById("tipoItem").textContent = item.isProdOuServico ? "Produto" : "Serviço";
        document.getElementById("ufItem").textContent = "UF: " + item.uf;
        document.getElementById("nomeUsuario").textContent = "Usuário: " + item.userNome;
        document.getElementById("descricaoItem").textContent = item.descricao || "";

        const catInteresse = [item.categoriaInteresse1,item.categoriaInteresse2,item.categoriaInteresse3].filter(Boolean).join(", ");
        document.getElementById("categoriasInteresse").textContent = catInteresse ? "Categorias de Interesse: " + catInteresse : "";

        const secImgs = ["imagemS01","imagemS02","imagemS03","imagemS04","imagemS05"];
        const containerImgs = document.getElementById("imagensSecundarias");
        containerImgs.innerHTML = "";
        secImgs.forEach(key => {
            if(item[key]){
                const img = document.createElement("img");
                img.src = `data:image/jpeg;base64,${item[key]}`;
                containerImgs.appendChild(img);
            }
        });

        const respUser = await fetch("http://localhost:8080/api/postagens/listar", {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const itensUsuario = await respUser.json();
        const container = document.getElementById("listaItensUsuario");
        container.innerHTML = "";

        itensUsuario.forEach(p => {
            const card = document.createElement("div");
            card.className = "item-card";

            const imgSrc = p.imagem ? `data:image/jpeg;base64,${p.imagem}` : './imagens/placeholder.png';
            const catInteresse = [p.categoriaInteresse1,p.categoriaInteresse2,p.categoriaInteresse3].filter(Boolean).join(", ");

            card.innerHTML = `
                <img src="${imgSrc}" alt="${p.nomePostagem}">
                <h6>${p.nomePostagem}</h6>
                <p>${p.isProdOuServico ? "Produto" : "Serviço"}</p>
                <p>UF: ${p.uf}</p>
                <p>Categoria: ${p.categoria}</p>
                <p>Categorias de interesse: ${catInteresse || "Nenhuma"}</p>
            `;

            card.addEventListener("click", () => {
                document.querySelectorAll(".item-card.selected").forEach(c => c.classList.remove("selected"));
                card.classList.add("selected");
                itemSelecionadoId = p.id;
            });

            container.appendChild(card);
        });

    } catch(e){
        console.error(e);
        Swal.fire({ title:"Erro", text:"Não foi possível carregar os detalhes.", icon:"error" });
    }
}

document.getElementById("btnPropor").addEventListener("click", async () => {
    if(!itemSelecionadoId){
        Swal.fire({ title:"Atenção", text:"Selecione um item seu para propor a troca.", icon:"warning" });
        return;
    }

    const itemDesejadoId = itemId;
    const itemOferecidoId = itemSelecionadoId;

    const jaExiste = propostasExistentes.some(p => 
        p.itemDesejadoId == itemDesejadoId && p.itemOferecidoId == itemOferecidoId
    );

    if(jaExiste){
        Swal.fire({ title:"Atenção", text:"Você já enviou uma proposta com esses itens.", icon:"warning" });
        return;
    }

    try{
        const resp = await fetch(`http://localhost:8080/api/propostas/criar?itemDesejadoId=${itemDesejadoId}&itemOferecidoId=${itemOferecidoId}`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await resp.json();
        if(resp.ok){
            Swal.fire({ title:"Sucesso!", text:"Proposta criada com sucesso!", icon:"success" });
            propostasExistentes.push({itemDesejadoId, itemOferecidoId});
        } else {
            Swal.fire({ title:"Erro", text: data.message || "Não foi possível criar a proposta.", icon:"error" });
        }
    } catch(err){
        console.error(err);
        Swal.fire({ title:"Erro", text:"Falha ao criar proposta.", icon:"error" });
    }
});

function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("userNome");
    window.location.href = 'login.html';
}

carregarPropostas();
carregarDetalhes();
</script>

</body>
</html>
