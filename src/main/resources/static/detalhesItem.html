<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Detalhes do Item</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f7e733, #f0d941, #e6e1a2);
        }

        main {
            flex: 1;
        }

        header.navbar {
            background-color: #ffca28 !important;
        }

        header .navbar-brand span {
            font-weight: 700;
            color: #222;
        }

        .detalhes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 20px;
            align-items: flex-start;
            justify-content: center;
        }

        .imagem-principal {
            flex: 2;
            max-width: 520px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-sizing: border-box;
        }

        .imagem-principal img {
            width: 100%;
            max-width: 350px;
            height: auto;
            border-radius: 12px;
            border: 2px solid #ffca28;
            object-fit: contain;
        }

        .imagens-secundarias {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .imagens-secundarias img {
            width: 90px;
            height: 90px;
            object-fit: contain;
            border-radius: 10px;
            border: 2px solid #ffca28;
            background: #fff;
            transition: transform 0.2s;
        }

        .imagens-secundarias img:hover {
            transform: scale(1.05);
        }

        .info-item {
            margin-top: 20px;
            width: 100%;
            text-align: left;
        }

        .info-item p {
            margin: 4px 0;
            font-size: 15px;
        }

        .info-item .descricao {
            margin-top: 12px;
            font-size: 15px;
            color: #444;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .lista-itens-usuario {
            flex: 1;
            max-height: 540px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-right: 5px;
        }

        .item-card {
            border: 2px solid #ffca28;
            border-radius: 16px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 200px;
            background-color: #fffdf6;
            transition: all 0.25s ease;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
        }

        .item-card.selected {
            border: 2px solid #ff9800;
            background-color: #fff3e0;
        }

        .item-card img {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
        }

        .item-card p {
            margin: 2px 0;
            font-size: 13px;
            color: #666;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            max-width: 100%;
        }

        .item-card h6 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            color: #222;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        /* Botão principal */
        #btnPropor {
            margin-top: 25px;
            width: 100%;
            font-weight: 600;
            border-radius: 10px;
            padding: 14px;
            background-color: #ffca28;
            border: none;
            color: #000;
            transition: 0.2s;
        }

        #btnPropor:hover {
            background-color: #ffb300;
            transform: translateY(-2px);
        }

        .btn-nav {
            background: #fff;
            color: #000;
            font-weight: bold;
            padding: 8px 22px;
            border-radius: 999px;
            border: 2px solid #000;
            box-shadow: 2px 3px 0px rgba(0, 0, 0, 0.25);
            transition: all 0.2s ease-in-out;
            position: relative;
            display: flex;
            top: 25px;
            right: 25px;
        }

        .btn-nav:hover {
            background: #000;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 3px 5px 0px rgba(0, 0, 0, 0.35);
        }

        .btn-nav:active {
            transform: scale(0.96);
            box-shadow: 1px 2px 0px rgba(0, 0, 0, 0.2);
        }

        .btn-nav:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.6);
        }

        .footer {
            background: #202020;
            color: #f5f5f5;
        }

        .footer a {
            color: #bbb;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #d4a017;
        }

        .footer h5 {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .footer .bi {
            font-size: 1.4rem;
            transition: transform 0.2s ease, color 0.3s ease;
        }

        .footer .bi:hover {
            color: #d4a017;
            transform: scale(1.1);
        }

        .footer-bottom {
            font-size: 13px;
            color: #aaa;
        }

        .produtos-grid {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            scroll-behavior: smooth;
        }

        .product-card {
            flex: 0 0 auto;
            width: 240px;
            margin-right: 16px;
        }

        #listaProdutos.produtos-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 330px;
            gap: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 1rem;
            scroll-snap-type: x mandatory;
        }

        #listaProdutos.produtos-grid::-webkit-scrollbar {
            height: 10px;
        }

        #listaProdutos.produtos-grid::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, .25);
            border-radius: 10px;
        }

        #listaProdutos.produtos-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, .05);
        }

        #listaProdutos .product-card {
            scroll-snap-align: start;
            background: #fff;
            border: 2px solid #000;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 320px;
            width: 100%;
            transition: transform .2s ease, box-shadow .2s ease;
        }

        #listaProdutos .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, .25);
        }

        #listaProdutos .product-card img {
            max-width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: .5rem;
            border-radius: 8px;
        }

        #listaProdutos .product-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-top: .5rem;
            color: #333;
            word-wrap: break-word;
            white-space: normal;
        }

        #listaProdutos .product-card p {
            font-size: .9rem;
            color: #444;
            word-wrap: break-word;
            white-space: normal;
            overflow: hidden;
        }

        #listaProdutos .product-card small {
            color: #777;
            font-size: .85rem;
            margin-top: auto;
        }

        .carrossel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            border: none;
            border-radius: 50%;
            padding: 10px 15px;
            cursor: pointer;
        }

        .carrossel-btn.start-0 {
            left: 10px;
        }

        .carrossel-btn.end-0 {
            right: 10px;
        }
    </style>
</head>

<body>

    <header class="bg-warning py-2 shadow-sm">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a class="navbar-brand fw-bold" href="#">
                <img src="imagens/logo.png" alt="LibertyHive" width="40" />
            </a>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm rounded-circle" title="Meus Favoritos"
                    onclick="window.location.href='favoritos.html'">
                    <i class="bi bi-heart"></i>
                </button>
                <button type="button" class="btn btn-outline-dark btn-sm rounded-circle" title="Configurações"
                    onclick="window.location.href='configuracao.html'">
                    <i class="bi bi-gear"></i>
                </button>
            </div>

        </div>
    </header>
    <div class="d-flex ms-auto gap-2">
        <button class="btn-nav" onclick="window.location.href='inicio.html'">
            <i class="bi bi-house me-1"></i> Início
        </button>
        <button class="btn-nav" onclick="logout()">
            <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
    </div>

    <main class="container my-5">
        <h2 id="nomePostagem" class="fw-bold text-dark mb-4"></h2>
        <div class="detalhes-container">
            <div class="imagem-principal">
                <img id="imgPrincipal" src="./imagens/placeholder.png" alt="Imagem do item">
                <div class="imagens-secundarias" id="imagensSecundarias"></div>
                <div class="info-item mt-3">
                    <p id="nomeUsuario" class="fw-semibold"></p>
                    <p id="tipoItem"></p>
                    <p id="ufItem"></p>
                    <p id="categoriaItem"></p>
                    <p id="categoriasInteresse" class="text-muted"></p>
                    <p class="descricao" id="descricaoItem"></p>
                </div>
            </div>
            <div class="lista-itens-usuario" id="listaItensUsuario"></div>
        </div>
        <button id="btnPropor" class="btn btn-warning mt-3">Propor Negócio</button>

        <h4 class="text-start mt-4 mb-3">Talvez isto te interesse...</h4>

        <div class="position-relative">
            <button class="btn btn-warning carrossel-btn start-0" onclick="scrollLista(-1)">
                <i class="bi bi-chevron-left fs-4"></i>
            </button>

            <div class="produtos-grid overflow-auto gap-3 pb-3 px-5" id="listaProdutos" tabindex="0"
                aria-label="Lista de postagens">
                <p class="text-muted">Carregando postagens...</p>
            </div>

            <button class="btn btn-warning carrossel-btn end-0" onclick="scrollLista(1)">
                <i class="bi bi-chevron-right fs-4"></i>
            </button>
        </div>

    </main>


    <script>
        const queryParams = new URLSearchParams(window.location.search);
        const itemId = queryParams.get("id");
        const token = localStorage.getItem("token");
        if (!token) window.location.href = 'login.html';

        function toBool(v) {
            if (v === true || v === 1) return true;
            if (v === false || v === 0) return false;
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                return s === 'true' || s === '1' || s === 'sim' || s === 'yes';
            }
            return Boolean(v);
        }

        let itemSelecionadoId = null;
        let propostasExistentes = [];
        let userLogado = localStorage.getItem("userNome");
        let isDoacao = false;
        function scrollLista(direcao) {
            const lista = document.getElementById("listaProdutos");
            const larguraCard = 330 + 16;
            lista.scrollBy({
                left: direcao * larguraCard,
                behavior: "smooth"
            });
        }
        async function carregarPropostas() {
            try {
                const resp = await fetch("http://localhost:8080/api/propostas/listarPropostas", {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!resp.ok) throw new Error("Erro ao buscar propostas");
                const data = await resp.json();
                propostasExistentes = data.map(p => ({
                    itemDesejadoId: p.itemDesejado?.id ?? null,
                    itemOferecidoId: p.itemOferecido?.id ?? null
                }));
            } catch (err) {
                console.error("Erro ao carregar propostas:", err);
            }
        }

        async function carregarDetalhes() {
            try {
                const resp = await fetch(`http://localhost:8080/api/postagens/${itemId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!resp.ok) throw new Error("Item não encontrado");
                const item = await resp.json();

                document.getElementById("nomePostagem").textContent = item.nomePostagem;
                document.getElementById("imgPrincipal").src = item.imagem ? `data:image/jpeg;base64,${item.imagem}` : './imagens/placeholder.png';
                document.getElementById("categoriaItem").textContent = "Categoria: " + (item.categoria ?? "");
                document.getElementById("tipoItem").textContent = toBool(item.isProdOuServico ?? item.prodOuServico ?? false) ? "Produto" : "Serviço";
                document.getElementById("ufItem").textContent = "UF: " + (item.uf ?? "");
                document.getElementById("nomeUsuario").textContent = "Usuário: " + (item.userNome ?? "");
                document.getElementById("descricaoItem").textContent = item.descricao || "";

                const catInteresse = [item.categoriaInteresse1, item.categoriaInteresse2, item.categoriaInteresse3].filter(Boolean).join(", ");
                document.getElementById("categoriasInteresse").textContent = catInteresse ? "Categorias de Interesse: " + catInteresse : "";

                const secImgs = ["imagemS01", "imagemS02", "imagemS03", "imagemS04", "imagemS05"];
                const containerImgs = document.getElementById("imagensSecundarias");
                containerImgs.innerHTML = "";
                secImgs.forEach(key => {
                    if (item[key]) {
                        const img = document.createElement("img");
                        img.src = `data:image/jpeg;base64,${item[key]}`;
                        containerImgs.appendChild(img);
                    }
                });

                isDoacao = toBool(item.isDoacao ?? item.doacao ?? false);

                const listaElem = document.getElementById("listaItensUsuario");
                const btnPropor = document.getElementById("btnPropor");

                if ((item.userNome ?? "") === (userLogado ?? "")) {
                    listaElem.style.display = "none";
                    btnPropor.style.display = "none";
                    return;
                }

                if (isDoacao) {
                    listaElem.style.display = "none";
                    btnPropor.textContent = "Solicitar Doação";
                } else {
                    listaElem.style.display = "";
                    btnPropor.textContent = "Propor Negócio";
                }

                if (!isDoacao) {
                    const respUser = await fetch("http://localhost:8080/api/postagens/listar", {
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    const itensUsuario = await respUser.json();
                    const container = document.getElementById("listaItensUsuario");
                    container.innerHTML = "";

                    itensUsuario.forEach(p => {
                        const card = document.createElement("div");
                        card.className = "item-card";

                        const imgSrc = p.imagem ? `data:image/jpeg;base64,${p.imagem}` : './imagens/placeholder.png';
                        const catInteresseP = [p.categoriaInteresse1, p.categoriaInteresse2, p.categoriaInteresse3].filter(Boolean).join(", ");

                        card.innerHTML = `
    <img src="${imgSrc}" alt="${p.nomePostagem}">
    <h6 title="${p.nomePostagem}">${p.nomePostagem}</h6>
    <p><strong>${toBool(p.isProdOuServico ?? p.prodOuServico ?? false) ? "Produto" : "Serviço"}</strong></p>
    <p class="text-muted" style="font-size:12px">UF: ${p.uf ?? ""}</p>
    <p class="text-muted" style="font-size:12px">Categoria: ${p.categoria ?? ""}</p>
`;

                        card.addEventListener("click", () => {
                            document.querySelectorAll(".item-card.selected").forEach(c => c.classList.remove("selected"));
                            card.classList.add("selected");
                            itemSelecionadoId = p.id;
                        });

                        container.appendChild(card);
                    });
                }

            } catch (e) {
                console.error(e);
                Swal.fire({ title: "Erro", text: "Não foi possível carregar os detalhes.", icon: "error" });
            }
        }

        document.getElementById("btnPropor").addEventListener("click", async () => {
            const itemDesejadoId = itemId;
            let itemOferecidoId = itemSelecionadoId;

            if (isDoacao) {
                itemOferecidoId = null;
            } else {
                if (!itemSelecionadoId) {
                    Swal.fire({
                        title: "Atenção",
                        text: "Selecione um item seu para propor o negócio.",
                        icon: "warning"
                    });
                    return;
                }
            }

            let jaExiste = false;
            if (isDoacao) {
                jaExiste = propostasExistentes.some(p => p.itemDesejadoId == itemDesejadoId);
            } else {
                jaExiste = propostasExistentes.some(p =>
                    p.itemDesejadoId == itemDesejadoId && p.itemOferecidoId == itemOferecidoId
                );
            }

            if (jaExiste) {
                Swal.fire({
                    title: "Atenção",
                    text: isDoacao ? "Você já solicitou doação para este item." : "Você já enviou uma proposta com esses itens.",
                    icon: "warning"
                });
                return;
            }

            const confirm = await Swal.fire({
                title: isDoacao ? "Confirmar solicitação de doação?" : "Confirmar proposta?",
                text: isDoacao ? "Deseja realmente solicitar esta doação?" : "Deseja realmente propor este negócio?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: isDoacao ? "Sim, solicitar" : "Sim, propor",
                cancelButtonText: "Cancelar"
            });

            if (!confirm.isConfirmed) return;

            try {
                let url = `http://localhost:8080/api/propostas/criar?itemDesejadoId=${itemDesejadoId}`;
                if (itemOferecidoId) url += `&itemOferecidoId=${itemOferecidoId}`;

                const resp = await fetch(url, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await resp.json();
                if (resp.ok) {
                    Swal.fire({
                        title: "Sucesso!",
                        text: isDoacao ? "Solicitação de doação enviada!" : "Proposta criada com sucesso!",
                        icon: "success"
                    });
                    propostasExistentes.push({ itemDesejadoId, itemOferecidoId: itemOferecidoId ?? null });
                } else {
                    Swal.fire({
                        title: "Erro",
                        text: data.message || "Não foi possível criar a proposta.",
                        icon: "error"
                    });
                }
            } catch (err) {
                console.error(err);
                Swal.fire({ title: "Erro", text: "Falha ao criar proposta.", icon: "error" });
            }
        });

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("userNome");
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const lista = document.getElementById('listaProdutos');
            lista.innerHTML = "<p class='text-muted'>Carregando postagens...</p>";

            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    lista.innerHTML = "<p class='text-danger'>Você precisa estar logado para ver as postagens.</p>";
                    return;
                }

                const response = await fetch("http://localhost:8080/api/postagens/listar-todas", {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) {
                    lista.innerHTML = "<p class='text-danger'>Erro ao carregar postagens.</p>";
                    return;
                }

                const postagens = await response.json();
                lista.innerHTML = "";

                if (!postagens || postagens.length === 0) {
                    lista.innerHTML = "<p class='text-muted'>Nenhuma postagem encontrada.</p>";
                    return;
                }

                const params = new URLSearchParams(window.location.search);
                const idAtual = params.get("id");

                const frag = document.createDocumentFragment();

                postagens.forEach(p => {
                    if (idAtual && p.id == idAtual) return;

                    const card = document.createElement('div');
                    card.className = 'product-card';

                    const cat = (p.categoria || '').toString();
                    const nomePost = (p.nomePostagem || '').toString();

                    card.dataset.id = p.id;

                    let imgSrc = "./imagens/placeholder.png";
                    if (p.imagem) imgSrc = `data:image/jpeg;base64,${p.imagem}`;

                    const doacao_string = p.doacao ? "Sim" : "Não";
                    const tipo_string = p.isProdOuServico ? "Produto" : "Serviço";

                    card.innerHTML = `
                <img src="${imgSrc}" alt="${escapeHtml(nomePost)}">
                <h3>${escapeHtml(nomePost)}</h3>
                <p><strong>Categoria:</strong> ${escapeHtml(cat)}</p>
                <p><strong>Tipo:</strong> ${tipo_string}</p>
                <p><strong>Doação:</strong> ${doacao_string}</p>
                <small>${escapeHtml(p.cidade || "")} - ${escapeHtml(p.uf || "")}</small>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-outline-danger btn-sm ver-detalhes-btn">Ver Detalhes</button>
                    <button class="btn btn-outline-danger btn-sm fav-btn"><i class="bi bi-heart"></i> Favoritar</button>
                </div>
            `;

                    card.querySelector('.ver-detalhes-btn').addEventListener('click', () => {
                        window.location.href = `detalhesItem.html?id=${p.id}`;
                    });

                    card.querySelector('.fav-btn').addEventListener('click', async () => {
                        if (!token) {
                            Swal.fire({
                                title: 'Erro',
                                text: 'Você precisa estar logado para favoritar.',
                                icon: 'error'
                            });
                            return;
                        }

                        try {
                            const response = await fetch("http://localhost:8080/favoritos?postagemId=" + p.id, {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${token}` }
                            });

                            const data = await response.json();

                            if (response.ok) {
                                Swal.fire({
                                    title: 'Item favoritado!',
                                    text: data.message,
                                    icon: 'success',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            } else if (response.status === 409) {
                                Swal.fire({
                                    title: 'Já favoritado',
                                    text: data.message,
                                    icon: 'info',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                            } else {
                                Swal.fire({
                                    title: 'Erro',
                                    text: data.message || 'Não foi possível favoritar este item.',
                                    icon: 'error'
                                });
                            }
                        } catch (error) {
                            Swal.fire({
                                title: 'Erro',
                                text: 'Não foi possível conectar ao servidor.',
                                icon: 'error'
                            });
                        }
                    });

                    frag.appendChild(card);
                });

                lista.appendChild(frag);

            } catch (error) {
                console.error("Erro ao carregar postagens:", error);
                lista.innerHTML = "<p class='text-danger'>Erro de conexão com o servidor.</p>";
            }
        });

        function escapeHtml(str) {
            return (str || '').toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        carregarPropostas();
        carregarDetalhes();
    </script>

    <footer class="footer mt-auto">
        <div class="container py-5">
            <div class="row gy-4">

                <div class="col-md-4">
                    <h5 class="text-white">Sobre</h5>
                    <p class="text-muted small mb-0">
                        Plataforma para trocar produtos e serviços de forma segura e prática.
                    </p>
                </div>

                <div class="col-md-4">
                    <h5 class="text-white">Links Úteis</h5>
                    <ul class="list-unstyled small">
                        <li><a href="#">Fale Conosco</a></li>
                        <li><a href="#">Suporte</a></li>
                        <li><a href="#">Denúncias</a></li>
                        <li><a href="#">Termos de Uso</a></li>
                        <li><a href="#">Política de Privacidade</a></li>
                    </ul>
                </div>

                <div class="col-md-4">
                    <h5 class="text-white">Redes Sociais</h5>
                    <div class="d-flex gap-3">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-twitter"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-linkedin"></i></a>
                    </div>
                </div>

            </div>

            <div class="footer-bottom text-center pt-4 mt-4 border-top">
                <small class="text-muted">© 2025 LibertyHive. Todos os direitos reservados.</small>
            </div>
        </div>
    </footer>
</body>
<script src="inicio.js"></script>

</html>