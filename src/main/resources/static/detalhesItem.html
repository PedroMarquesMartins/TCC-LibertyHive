<!DOCTYPE html>
<html lang="pt-br">
<!--Detalhes do Item Page-->
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Item</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="favicon.png" />
        <link rel="stylesheet" href="./Style/detalhesItem.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body><!--Cabeçalho da pagina-->
    <header class="bg-warning py-2 shadow-sm">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a class="navbar-brand fw-bold" href="inicio.html">
                <img src="imagens/logo.png" alt="LibertyHive" width="40" />
            </a>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm rounded-circle" title="Meus Favoritos"
                    onclick="window.location.href='favoritos.html'">
                    <i class="bi bi-heart"></i>
                </button>
                <button type="button" class="btn btn-outline-dark btn-sm rounded-circle" title="Configurações"
                    onclick="window.location.href='configuracao.html'">
                    <i class="bi bi-gear"></i>
                </button>
            </div>
<!--Botões de navegação-->
        </div>
    </header>
    <div class="d-flex ms-auto gap-2">
        <button class="btn-nav" onclick="window.location.href='inicio.html'">
            <i class="bi bi-house me-1"></i> Início
        </button>
        <button class="btn-nav" onclick="logout()">
            <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
    </div>
    <!--Conteúdo principal da pagina-->
    <main class="container my-5">
        <h2 id="nomePostagem" class="fw-bold text-dark mb-4"></h2>
        <div class="detalhes-container">
            <div class="imagem-principal">
                <img id="imgPrincipal" src="./imagens/placeholder.png" alt="Imagem do item">
                <div class="imagens-secundarias" id="imagensSecundarias"></div>
                <div class="info-item mt-3">
                    <p id="nomeUsuario" class="fw-semibold"></p>
                    <div id="avaliacaoUsuario" class="mb-2"></div>
                    <p id="tipoItem"></p>
                    <p id="ufItem"></p>
                    <p id="categoriaItem"></p>
                    <p id="categoriasInteresse" class="text-muted"></p>
                    <p class="descricao" id="descricaoItem"></p>
                </div>
            </div>
            <div class="lista-itens-usuario" id="listaItensUsuario"></div>
        </div>
        <button id="btnPropor" class="btn btn-warning mt-3">Propor Negócio</button>
            <!--Sugestões de outros produtos--> 
        <h4 class="text-start mt-4 mb-3">Talvez isto te interesse...</h4>
        <!--Carrossel de produtos-->
        <div class="position-relative">
            <button class="btn btn-warning carrossel-btn start-0" onclick="scrollLista(-1)">
                <i class="bi bi-chevron-left fs-4"></i>
            </button>

            <div class="produtos-grid overflow-auto gap-3 pb-3 px-5" id="listaProdutos" tabindex="0"
                aria-label="Lista de postagens">
                <p class="text-muted">Carregando postagens...</p>
            </div>
    <!--Botões de navegação do carrossel-->
            <button class="btn btn-warning carrossel-btn end-0" onclick="scrollLista(1)">
                <i class="bi bi-chevron-right fs-4"></i>
            </button>
        </div>

    </main>

    <script>
        //Pegar o ID do item na URL
        const queryParams = new URLSearchParams(window.location.search);
        const itemId = queryParams.get("id");
        const token = localStorage.getItem("token");
        if (!token) window.location.href = 'login.html';
//Variáveis globais
        let itemDetalhe = null;
        let itemSelecionadoId = null;
        let propostasExistentes = [];
        let userLogado = localStorage.getItem("userNome");
        let isDoacao = false;
        //Função para obter dados do usuário logado
        function getLoggedUser() {
            const userIdStr = localStorage.getItem('userId');
            const userNome = localStorage.getItem('userNome');
            const userId = userIdStr ? parseInt(userIdStr, 10) : null;
            if (!userId || !userNome) return null;
            return { userId, userNome };
        }
//  Converter valores variados para booleano
        function toBool(v) {
            if (v === true || v === 1) return true;
            if (v === false || v === 0) return false;
            if (typeof v === 'string') {
                const s = v.trim().toLowerCase();
                return s === 'true' || s === '1' || s === 'sim' || s === 'yes';
            }
            return Boolean(v);
        }
        //      Rolar a lista de produtos no carrossel
        function scrollLista(direcao) {
            const lista = document.getElementById("listaProdutos");
            const larguraCard = 330 + 16;
            lista.scrollBy({ left: direcao * larguraCard, behavior: "smooth" });
        }


        //Carregar detalhes do item ao iniciar a agina Não MEXERRRR
        async function carregarPropostas() {
            try {
                const resp = await fetch("http://localhost:8080/api/propostas/listarPropostas", {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!resp.ok) throw new Error("Erro ao buscar propostas");
                const data = await resp.json();
                propostasExistentes = data.map(p => ({
                    itemDesejadoId: p.itemDesejado?.id ?? null,
                    itemOferecidoId: p.itemOferecido?.id ?? null
                }));
            } catch (err) {
                console.error("Erro ao carregar propostas:", err);
            }
        }

        //Criar HTML para exibir avaliação em estrelas
        function criarHTMLAvaliacao(media) {
            const nota = parseFloat(media);

            if (media == null || isNaN(nota) || nota === 0) {
                return '<div class="rating-stars" style="color: #6c757d; font-size: 0.9rem;"><i>(Sem avaliações)</i></div>';
            }

            let estrelasHTML = '<strong>Avaliação: </strong>';
            const notaArredondada = Math.round(nota * 2) / 2;
            const fullStars = Math.floor(notaArredondada);
            const halfStar = (notaArredondada % 1 !== 0);
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) estrelasHTML += '<i class="bi bi-star-fill text-warning"></i>';
            if (halfStar) estrelasHTML += '<i class="bi bi-star-half text-warning"></i>';
            for (let i = 0; i < emptyStars; i++) estrelasHTML += '<i class="bi bi-star text-warning"></i>';
            return `<div class="rating-stars">${estrelasHTML} <span class="fw-bold">${nota.toFixed(1)}</span></div>`;
        }
        
        
        //  Carrega detalhes do item
        async function carregarDetalhes() {
            try {
                const resp = await fetch(`http://localhost:8080/api/postagens/${itemId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!resp.ok) throw new Error("Item não encontrado");
                const item = await resp.json();
                //Preencher os detalhes na página
                itemDetalhe = item;
                document.getElementById("nomePostagem").textContent = item.nomePostagem;
                document.getElementById("imgPrincipal").src = item.imagem ? `data:image/jpeg;base64,${item.imagem}` : './imagens/placeholder.png';
                document.getElementById("categoriaItem").textContent = "Categoria: " + (item.categoria ?? "");
                document.getElementById("tipoItem").textContent = toBool(item.isProdOuServico ?? item.prodOuServico ?? false) ? "Produto" : "Serviço";
                document.getElementById("ufItem").textContent = "UF: " + (item.uf ?? "");
                document.getElementById("nomeUsuario").textContent = "Usuário: " + (item.userNome ?? "");
                document.getElementById("descricaoItem").textContent = item.descricao || "";
                const avaliacaoContainer = document.getElementById("avaliacaoUsuario");
                avaliacaoContainer.innerHTML = criarHTMLAvaliacao(null);
                if (item.userID) {
                    try {
                        const respTodas = await fetch("http://localhost:8080/api/postagens/listar-todas", {
                            headers: { "Authorization": `Bearer ${token}` }
                        });//Buscar todas postagens para pegar avaliação do usuário
                        if (respTodas.ok) {
                            const todasPostagens = await respTodas.json();
                            const postagemDoUsuario = todasPostagens.find(p => p.userID === item.userID);
                            let avaliacao = null;
                            if (postagemDoUsuario) {
                                avaliacao = postagemDoUsuario.avaliacaoUsuario;
                            }
                            avaliacaoContainer.innerHTML = criarHTMLAvaliacao(avaliacao);
                        }
                    } catch (err) {
                        console.error("Erro ao buscar lista completa para avaliação:", err);
                    }
                }
                //Categorias de interesse
                const catInteresse = [item.categoriaInteresse1, item.categoriaInteresse2, item.categoriaInteresse3].filter(Boolean).join(", ");
                document.getElementById("categoriasInteresse").textContent = catInteresse ? "Categorias de Interesse: " + catInteresse : "";
                const secImgs = ["imagemS01", "imagemS02", "imagemS03", "imagemS04", "imagemS05"];
                const containerImgs = document.getElementById("imagensSecundarias");
                containerImgs.innerHTML = "";
                secImgs.forEach(key => {
                    if (item[key]) {
                        const img = document.createElement("img");
                        img.src = `data:image/jpeg;base64,${item[key]}`;
                        containerImgs.appendChild(img);
                    }
                });//Configurar logica dos botoes dependendo se e doacao ou troca
                isDoacao = toBool(item.isDoacao ?? item.doacao ?? false);
                const listaElem = document.getElementById("listaItensUsuario");
                const btnPropor = document.getElementById("btnPropor");
                const containerBotoes = btnPropor.parentNode;
                let btnChatExistente = document.getElementById("btnChatProposta");
                if (btnChatExistente) containerBotoes.removeChild(btnChatExistente);
                if ((item.userNome ?? "") === (userLogado ?? "")) {
                    listaElem.style.display = "none";
                    btnPropor.style.display = "none";
                    return;
                }//Verificar se já existe proposta entre os itens
                if (isDoacao) {
                    listaElem.style.display = "none";
                    btnPropor.textContent = "Solicitar Doação";
                } else {
                    listaElem.style.display = "";
                    btnPropor.textContent = "Propor Negócio";
                }
                //Verificar propostas existentes
                btnPropor.style.display = "";
                const btnChat = document.createElement('button');
                btnChat.id = 'btnChatProposta';
                btnChat.className = btnPropor.className || 'btn btn-primary';
                btnChat.textContent = 'Chat';
                btnChat.onclick = async () => {//Lógica para abrir ou criar chat
                    const loggedUser = getLoggedUser();
                    if (!loggedUser) { alert('Erro: usuário não identificado corretamente.'); return; }
                    const { userId: userIdLogado, userNome: userNomeLogado } = loggedUser;
                    const outroId = itemDetalhe.userID;
                    const outroNome = itemDetalhe.userNome;
                    console.log("IDs para chat:", userIdLogado, outroId);
                    if (!outroId || !outroNome) { alert('Erro: usuário alvo do chat não identificado.'); return; }
                    try {
                        const response = await fetch(`http://localhost:8080/chat/criar?userId01=${userIdLogado}&userId02=${outroId}&userNome01=${encodeURIComponent(userNomeLogado)}&userNome02=${encodeURIComponent(outroNome)}`, {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + token }//Enviar requisição para criar ou obter chat
                        });
                        const data = await response.json();
                        if (response.ok && data.id) {
                            window.location.href = `chat.html?chatId=${data.id}`;
                        } else {
                            console.error('Erro resposta servidor:', data);
                            alert('Erro ao criar ou carregar chat.');
                        }
                    } catch (err) {
                        console.error('Erro ao tentar criar chat:', err);
                        alert('Falha na conexão com o servidor.');
                    }
                };

                //Adicionar botão de chat
                btnPropor.insertAdjacentElement('afterend', btnChat);
                const btnFav = document.createElement('button');
                btnFav.id = 'btnFavDetalhe';
                btnFav.className = 'btn btn-warning mt-3';
                btnFav.style.width = '100%';
                btnFav.style.fontWeight = '600';
                btnFav.style.borderRadius = '10px';
                btnFav.style.padding = '14px';
                btnFav.innerHTML = `<i class="bi bi-heart-fill me-1"></i> Favoritar`;

                btnFav.addEventListener('mouseover', () => { //Efeito
                    btnFav.style.backgroundColor = '#ffb300';
                    btnFav.style.transform = 'translateY(-2px)';
                });
                btnFav.addEventListener('mouseout', () => {
                    btnFav.style.backgroundColor = '#ffca28';
                    btnFav.style.transform = 'none';
                });

                //Adicionar logica de favoritar
                btnFav.onclick = async () => {
                    const postagemId = itemDetalhe.id;
                    const token = localStorage.getItem("token");
                    if (!token) {
                        Swal.fire({
                            title: 'Erro',
                            text: 'Você precisa estar logado para favoritar.',
                            icon: 'error'
                        });
                        return;
                    }
                        //Enviar requisição para favoritar o item
                    try {
                        const response = await fetch("http://localhost:8080/favoritos?postagemId=" + postagemId, {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        const data = await response.json();
            //Tratar resposta do servidor
                        if (response.ok) {
                            Swal.fire({
                                title: 'Item favoritado!',
                                text: data.message,
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else if (response.status === 409) {
                            Swal.fire({
                                title: 'Já favoritado',
                                text: data.message,
                                icon: 'info',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                title: 'Erro',
                                text: data.message || 'Não foi possível favoritar este item.',
                                icon: 'error'
                            });
                        }
                    } catch (error) {
                        console.error("Erro ao favoritar:", error);
                        Swal.fire({
                            title: 'Erro',
                            text: 'Não foi possível conectar ao servidor.',
                            icon: 'error'
                        });
                    }
                };
            //Adicionar botao de favoritos
                btnChat.insertAdjacentElement('afterend', btnFav);
                if (!isDoacao) {
                    const respUser = await fetch("http://localhost:8080/api/postagens/listar", {
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    const itensUsuario = await respUser.json();
                    const container = document.getElementById("listaItensUsuario");
                    container.innerHTML = "";
                        //Exibir itens do usuário logado
                    if (!itensUsuario || itensUsuario.length === 0) {
                        container.innerHTML = `
    <p class="text-center fw-bold text-muted" style="margin-top: 20px;">
        Você não tem itens para negociar ainda.
    </p>
`;
                    } else {//Criar cards para cada item
                        itensUsuario.forEach(p => {
                            const card = document.createElement("div");
                            card.className = "item-card";
                            const imgSrc = p.imagem ? `data:image/jpeg;base64,${p.imagem}` : './imagens/placeholder.png';
                            card.innerHTML = `
            <img src="${imgSrc}" alt="${p.nomePostagem}">
            <h6 title="${p.nomePostagem}">${p.nomePostagem}</h6>
            <p><strong>${toBool(p.isProdOuServico ?? p.prodOuServico ?? false) ? "Produto" : "Serviço"}</strong></p>
            <p class="text-muted" style="font-size:12px">UF: ${p.uf ?? ""}</p>
            <p class="text-muted" style="font-size:12px">Categoria: ${p.categoria ?? ""}</p>
        `;
                            card.addEventListener("click", () => {
                                document.querySelectorAll(".item-card.selected").forEach(c => c.classList.remove("selected"));
                                card.classList.add("selected");
                                itemSelecionadoId = p.id;
                            });
                            container.appendChild(card);
                        });
                    }

                }
            } catch (e) {
                console.error(e);
                Swal.fire({ title: "Erro", text: "Não foi possível carregar os detalhes.", icon: "error" });
            }
        }

        //Chamar funções ao carregar a página
        document.getElementById("btnPropor").addEventListener("click", async () => {
            const itemDesejadoId = itemId;
            let itemOferecidoId = itemSelecionadoId;

            if (isDoacao) itemOferecidoId = null;
            else if (!itemSelecionadoId) {
                Swal.fire({
                    title: "Atenção",
                    text: "Selecione um item seu para propor o negócio.",
                    icon: "warning"
                });
                return;
            }
//Verificar se ja existe proposta igual
            let jaExiste = isDoacao
                ? propostasExistentes.some(p => p.itemDesejadoId == itemDesejadoId)
                : propostasExistentes.some(p => p.itemDesejadoId == itemDesejadoId && p.itemOferecidoId == itemOferecidoId);

            if (jaExiste) {
                Swal.fire({
                    title: "Atenção",
                    text: isDoacao ? "Você já solicitou doação para este item." : "Você já enviou uma proposta com esses itens.",
                    icon: "warning"
                });
                return;
            }
                //Confirmar acao com o usuário
            const confirm = await Swal.fire({
                title: isDoacao ? "Confirmar solicitação de doação?" : "Confirmar proposta?",
                text: isDoacao ? "Deseja realmente solicitar esta doação?" : "Deseja realmente propor este negócio?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: isDoacao ? "Sim, solicitar" : "Sim, propor",
                cancelButtonText: "Cancelar"
            });
            //Verificar se o usuário confirmou a ação
            if (!confirm.isConfirmed) return;

            Swal.fire({
                title: 'Enviando proposta...',
                html: 'Aguarde enquanto processamos.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                let url = `http://localhost:8080/api/propostas/criar?itemDesejadoId=${itemDesejadoId}`;
                if (itemOferecidoId) url += `&itemOferecidoId=${itemOferecidoId}`;

                const resp = await fetch(url, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await resp.json();
                Swal.close();
                if (resp.ok) {
                    Swal.fire({
                        title: "Sucesso!",
                        text: isDoacao ? "Solicitação de doação enviada!" : "Proposta criada com sucesso!",
                        icon: "success"
                    });
                    propostasExistentes.push({ itemDesejadoId, itemOferecidoId: itemOferecidoId ?? null });
                } else {
                    Swal.fire({
                        title: "Erro",
                        text: data.message || "Não foi possível criar a proposta.",
                        icon: "error"
                    });
                }
            } catch (err) {
                Swal.close();
                console.error(err);
                Swal.fire({ title: "Erro", text: "Falha ao criar proposta.", icon: "error" });
            }
        });


        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("userNome");
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const lista = document.getElementById('listaProdutos');
            lista.innerHTML = "<p class='text-muted'>Carregando postagens...</p>";
//Carregar postagens para o carrossel exibir outros produtos
            try {
                if (!token) { lista.innerHTML = "<p class='text-danger'>Você precisa estar logado para ver as postagens.</p>"; return; }

                const response = await fetch("http://localhost:8080/api/postagens/listar-todas", {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) { lista.innerHTML = "<p class='text-danger'>Erro ao carregar postagens.</p>"; return; }

                const postagens = await response.json();
                lista.innerHTML = "";
                if (!postagens || postagens.length === 0) { lista.innerHTML = "<p class='text-muted'>Nenhuma postagem encontrada.</p>"; return; }

                const idAtual = new URLSearchParams(window.location.search).get("id");
                const frag = document.createDocumentFragment();

                postagens.forEach(p => {
                    if (idAtual && p.id == idAtual) return;

                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.dataset.id = p.id;

                    const imgSrc = p.imagem ? `data:image/jpeg;base64,${p.imagem}` : "./imagens/placeholder.png";
                    const doacao_string = toBool(p.isDoacao ?? p.doacao ?? false) ? "Sim" : "Não";
                    const tipo_string = toBool(p.isProdOuServico ?? p.prodOuServico ?? false) ? "Produto" : "Serviço";

                    card.innerHTML = `
                <img src="${imgSrc}" alt="${escapeHtml(p.nomePostagem || '')}">
                <h3>${escapeHtml(p.nomePostagem || '')}</h3>
                <p><strong>Categoria:</strong> ${escapeHtml(p.categoria || '')}</p>
                <p><strong>Tipo:</strong> ${tipo_string}</p>
                <p><strong>Doação:</strong> ${doacao_string}</p>
                <small>${escapeHtml(p.cidade || "")} - ${escapeHtml(p.uf || "")}</small>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-outline-danger btn-sm ver-detalhes-btn">Ver Detalhes</button>
                    <button class="btn btn-outline-danger btn-sm fav-btn"><i class="bi bi-heart"></i> Favoritar</button>
                </div>
            `;

                    card.querySelector('.ver-detalhes-btn').addEventListener('click', () => {
                        window.location.href = `detalhesItem.html?id=${p.id}`;
                    });

                    card.querySelector('.fav-btn').addEventListener('click', async () => {
                        if (!token) { Swal.fire({ title: 'Erro', text: 'Você precisa estar logado para favoritar.', icon: 'error' }); return; }
                        try {
                            const response = await fetch("http://localhost:8080/favoritos?postagemId=" + p.id, {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${token}` }
                            });
                            const data = await response.json();
                            if (response.ok) Swal.fire({ title: 'Item favoritado!', text: data.message, icon: 'success', timer: 2000, showConfirmButton: false });
                            else if (response.status === 409) Swal.fire({ title: 'Já favoritado', text: data.message, icon: 'info', timer: 2000, showConfirmButton: false });
                            else Swal.fire({ title: 'Erro', text: data.message || 'Não foi possível favoritar este item.', icon: 'error' });
                        } catch { Swal.fire({ title: 'Erro', text: 'Não foi possível conectar ao servidor.', icon: 'error' }); }
                    });

                    frag.appendChild(card);
                });

                lista.appendChild(frag);

            } catch (error) {
                console.error("Erro ao carregar postagens:", error);
                lista.innerHTML = "<p class='text-danger'>Erro de conexão com o servidor.</p>";
            }
        });

        function escapeHtml(str) {
            return (str || '').toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        carregarPropostas();
        carregarDetalhes();
    </script>

    <footer class="footer mt-auto">
        <div class="container py-5">
            <div class="row gy-4">

                <div class="col-md-4">
                    <h5 class="text-white">Sobre</h5>
                    <p class="text-muted small mb-0">
                        Plataforma para trocar produtos e serviços de forma segura e prática.
                    </p>
                </div>
                <div class="col-md-4">
                    <h5 class="text-white">Links Úteis</h5>
                    <ul class="list-unstyled small">
                        <li><a href="./footer pages/faleConosco.html">Fale Conosco</a></li>
                        <li><a href="./footer pages/suporte.html">Suporte</a></li>
                        <li><a href="./footer pages/denuncias.html">Denúncias</a></li>
                        <li><a href="./footer pages/termos.html">Termos de Uso</a></li>
                    <li><a href="./footer pages/privacidade.html">Política de Privacidade</a></li>
                    </ul>
                </div>

                <div class="col-md-4">
                    <h5 class="text-white">Redes Sociais</h5>
                    <div class="d-flex gap-3">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-twitter"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-linkedin"></i></a>
                    </div>
                </div>

            </div>

            <div class="footer-bottom text-center pt-4 mt-4 border-top">
                <small class="text-muted">© 2025 LibertyHive. Todos os direitos reservados.</small>
            </div>
        </div>
    </footer>
</body>
<script src="inicio.js"></script>
</html>