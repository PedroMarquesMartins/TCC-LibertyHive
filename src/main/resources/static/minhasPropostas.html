<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Minhas Propostas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .proposta-card {
            display: flex;
            justify-content: space-between;
            background-color: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .item-card {
            width: 48%;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #fafafa;
        }

        .item-card h3 {
            margin-top: 0;
        }

        .acoes {
            margin-top: 10px;
        }

        .acoes button {
            margin-right: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .cancelar {
            background-color: #f44336;
            color: white;
        }

        .concluir {
            background-color: #4caf50;
            color: white;
        }

        .recusar {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>

<body>
    <h1>Minhas Propostas</h1>
    <div id="propostasContainer"></div>

    <script>
        const token = localStorage.getItem('token');
        async function carregarPropostas() {
            try {
                const res = await fetch('http://localhost:8080/api/propostas/listarPropostas', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                if (!res.ok) throw new Error('Erro ao buscar propostas');

                const propostas = await res.json();
                const container = document.getElementById('propostasContainer');
                container.innerHTML = '';
                propostas.forEach(p => {
                    const card = document.createElement('div');
                    card.classList.add('proposta-card');

                    const itemDesejado = document.createElement('div');
                    itemDesejado.classList.add('item-card');
                    itemDesejado.innerHTML = `
                        <h3>${p.itemDesejado.nomePostagem}</h3>
                        <p>${p.itemDesejado.descricao}</p>
                        <p><b>Categoria:</b> ${p.itemDesejado.categoria}</p>
                        <p><b>Cidade:</b> ${p.itemDesejado.cidade} - ${p.itemDesejado.uf}</p>
                        <p><b>Disponibilidade:</b> ${p.itemDesejado.disponibilidade ? 'Sim' : 'Não'}</p>
                    `;
                    const itemOferecido = document.createElement('div');
                    itemOferecido.classList.add('item-card');
                    if (p.itemOferecido) {
                        itemOferecido.innerHTML = `
                            <h3>${p.itemOferecido.nomePostagem}</h3>
                            <p>${p.itemOferecido.descricao}</p>
                            <p><b>Categoria:</b> ${p.itemOferecido.categoria}</p>
                            <p><b>Cidade:</b> ${p.itemOferecido.cidade} - ${p.itemOferecido.uf}</p>
                            <p><b>Disponibilidade:</b> ${p.itemOferecido.disponibilidade ? 'Sim' : 'Não'}</p>
                        `;
                    } else {
                        itemOferecido.innerHTML = '<h3>Doação</h3><p>Não há item oferecido</p>';
                    }

                    const acoes = document.createElement('div');
                    acoes.classList.add('acoes');

                    if (p.podeCancelar) {
                        const btnCancelar = document.createElement('button');
                        btnCancelar.classList.add('cancelar');
                        btnCancelar.innerText = 'Cancelar';
                        btnCancelar.onclick = () => atualizarStatus(p.idProposta, 'cancelar');
                        acoes.appendChild(btnCancelar);
                    }
                    if (p.podeConcluir) {
                        const btnConcluir = document.createElement('button');
                        btnConcluir.classList.add('concluir');
                        btnConcluir.innerText = 'Concluir';
                        btnConcluir.onclick = () => atualizarStatus(p.idProposta, 'concluir');
                        acoes.appendChild(btnConcluir);
                    }
                    if (p.podeRecusar) {
                        const btnRecusar = document.createElement('button');
                        btnRecusar.classList.add('recusar');
                        btnRecusar.innerText = 'Recusar';
                        btnRecusar.onclick = () => atualizarStatus(p.idProposta, 'recusar');
                        acoes.appendChild(btnRecusar);
                    }

                    card.appendChild(itemDesejado);
                    card.appendChild(itemOferecido);
                    card.appendChild(acoes);
                    container.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                alert('Erro ao carregar propostas');
            }
        }

        async function atualizarStatus(propostaId, acao) {
            try {
                const res = await fetch(`http://localhost:8080/api/propostas/acao?propostaId=${propostaId}&acao=${acao}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                if (!res.ok) throw new Error('Erro ao atualizar proposta');
                carregarPropostas();
            } catch (err) {
                console.error(err);
                alert('Erro ao atualizar proposta');
            }
        }


        
        carregarPropostas();
    </script>
</body>

</html>